services:
  # OpenCode server - AI coding agent
  opencode:
    build:
      context: .
      dockerfile: Dockerfile.opencode
    container_name: opencode-server
    environment:
      - OPENCODE_SERVER_PASSWORD=${OPENCODE_PASSWORD:-changeme}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
    volumes:
      - ${PROJECT_DIR:-./workspace}:/workspace
      - opencode-data:/root/.local/share/opencode
      - opencode-state:/root/.local/state/opencode
    working_dir: /workspace
    command: ["serve", "--hostname=0.0.0.0", "--port=4096"]
    restart: unless-stopped

  # LINE bot - bridges LINE messages to OpenCode
  line-bot:
    build: .
    container_name: opencode-line-bot
    environment:
      - LINE_CHANNEL_ACCESS_TOKEN=${LINE_CHANNEL_ACCESS_TOKEN}
      - LINE_CHANNEL_SECRET=${LINE_CHANNEL_SECRET}
      - PORT=3000
      - OPENCODE_URL=http://opencode:4096
      - OPENCODE_PASSWORD=${OPENCODE_PASSWORD:-changeme}
      - OPENCODE_DIR=/workspace
      - LINE_OA_URL=${LINE_OA_URL:-}
    depends_on:
      - opencode
    restart: unless-stopped

  # Cloudflare tunnel - exposes LINE webhook to internet
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: opencode-line-tunnel
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      - line-bot
    restart: unless-stopped

volumes:
  opencode-data:
  opencode-state:
